name: Backend CI/CD

on:
  push:
    branches:
      - dev
      - main

env:
  NODE_VERSION: '24'
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: norohim/pro-mata-backend

jobs:
  build-and-verify:
    name: Build & Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build

      - name: Lint code
        run: npm run lint || echo "Lint not configured, skipping..."

  publish-dev:
    name: Publish DEV Image
    needs: [build-and-verify]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    outputs:
      image_tag: ${{ steps.define-tags.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Define image tags
        id: define-tags
        env:
          SHA: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo "${SHA}" | cut -c1-12)
          echo "image_tag=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push image
        id: docker_build_dev
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.dev
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:dev
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.define-tags.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Print Image Digest
        run: echo "DEV image pushed with digest ${{ steps.docker_build_dev.outputs.digest }}"

  publish-prod:
    name: Publish PROD Image
    needs: [build-and-verify]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      image_tag: ${{ steps.define-tags.outputs.image_tag }}
      version_tag: ${{ steps.define-tags.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Define image tags
        id: define-tags
        env:
          SHA: ${{ github.sha }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          SHORT_SHA=$(echo "${SHA}" | cut -c1-12)
          echo "image_tag=prod-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "version_tag=v${RUN_NUMBER}" >> $GITHUB_OUTPUT

      - name: Build and push image
        id: docker_build_prod
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prod
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:prod
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.define-tags.outputs.image_tag }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.define-tags.outputs.version_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Print Image Digest
        run: echo "PROD image pushed with digest ${{ steps.docker_build_prod.outputs.digest }}"

  deploy-dev:
    name: Deploy DEV to EC2
    needs: [publish-dev]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    env:
      IMAGE: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
      IMAGE_TAG: ${{ needs.publish-dev.outputs.image_tag }}
    steps:
      - name: Deploy container on DEV host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ${{ secrets.DEV_EC2_USER }}
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          envs: IMAGE,IMAGE_TAG
          script: |
            set -euo pipefail
            IMAGE_WITH_TAG="${IMAGE}:${IMAGE_TAG}"
            CONTAINER="${{ secrets.DEV_DOCKER_CONTAINER_NAME }}"
            PORTS="${{ secrets.DEV_DOCKER_PORT_MAPPING }}"
            ENV_FILE="${{ secrets.DEV_DOCKER_ENV_FILE }}"
            EXTRA_ARGS="${{ secrets.DEV_DOCKER_EXTRA_ARGS }}"

            docker pull "${IMAGE_WITH_TAG}"

            docker stop "${CONTAINER}" || true
            docker rm "${CONTAINER}" || true

            ENV_FLAG=""
            if [ -n "${ENV_FILE}" ]; then
              ENV_FLAG="--env-file ${ENV_FILE}"
            fi

            EXTRA_FLAG=""
            if [ -n "${EXTRA_ARGS}" ]; then
              EXTRA_FLAG="${EXTRA_ARGS}"
            fi

            docker run -d \
              --name "${CONTAINER}" \
              -p "${PORTS}" \
              ${ENV_FLAG} \
              ${EXTRA_FLAG} \
              --restart always \
              "${IMAGE_WITH_TAG}"

            docker exec "${CONTAINER}" npx prisma migrate deploy || true

  deploy-prod:
    name: Deploy PROD to EC2
    needs: [publish-prod]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      IMAGE: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
      IMAGE_TAG: ${{ needs.publish-prod.outputs.image_tag }}
    steps:
      - name: Deploy container on PROD host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          envs: IMAGE,IMAGE_TAG
          script: |
            set -euo pipefail
            IMAGE_WITH_TAG="${IMAGE}:${IMAGE_TAG}"
            CONTAINER="${{ secrets.PROD_DOCKER_CONTAINER_NAME }}"
            PORTS="${{ secrets.PROD_DOCKER_PORT_MAPPING }}"
            ENV_FILE="${{ secrets.PROD_DOCKER_ENV_FILE }}"
            EXTRA_ARGS="${{ secrets.PROD_DOCKER_EXTRA_ARGS }}"

            docker pull "${IMAGE_WITH_TAG}"
            docker pull "${IMAGE}:latest" || true

            docker stop "${CONTAINER}" || true
            docker rm "${CONTAINER}" || true

            ENV_FLAG=""
            if [ -n "${ENV_FILE}" ]; then
              ENV_FLAG="--env-file ${ENV_FILE}"
            fi

            EXTRA_FLAG=""
            if [ -n "${EXTRA_ARGS}" ]; then
              EXTRA_FLAG="${EXTRA_ARGS}"
            fi

            docker run -d \
              --name "${CONTAINER}" \
              -p "${PORTS}" \
              ${ENV_FLAG} \
              ${EXTRA_FLAG} \
              --restart always \
              "${IMAGE_WITH_TAG}"

            docker exec "${CONTAINER}" npx prisma migrate deploy || true